<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI æ‰‹åŠ¿è¯†åˆ«ä¸ç²’å­æ§åˆ¶</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Segoe UI', sans-serif; }
        
        /* è§†é¢‘åé¦ˆ (å·¦ä¸‹è§’) */
        .input_video {
            position: absolute; bottom: 20px; left: 20px; z-index: 10;
            width: 160px; border-radius: 8px; opacity: 0.6;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
            border: 2px solid rgba(255,255,255,0.2);
        }

        /* æ ¸å¿ƒ HUD æ˜¾ç¤ºåŒºåŸŸ */
        #gesture-hud {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; z-index: 20;
            mix-blend-mode: screen;
        }
        
        /* æ•°å­—/æ„ä¹‰æ˜¾ç¤º */
        #hud-result {
            font-size: 120px; font-weight: 900; color: rgba(255,255,255,0.9);
            text-shadow: 0 0 30px #00d2ff, 0 0 60px #00d2ff;
            letter-spacing: 5px; margin: 0;
            transition: all 0.2s;
        }
        
        /* è¾…åŠ©è¯´æ˜ */
        #hud-desc {
            font-size: 24px; color: rgba(255,255,255,0.7);
            text-transform: uppercase; letter-spacing: 3px;
            margin-top: -10px;
        }

        /* UI é¢æ¿ */
        #ui-container {
            position: absolute; top: 20px; right: 20px; color: white;
            background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px;
        }

        #loading {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: black; display:flex; align-items:center; justify-content:center;
            color: #00d2ff; z-index: 100; font-size: 20px;
        }
    </style>
    
    <!-- å¼•å…¥ä¾èµ– -->
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="loading">ğŸ§  æ­£åœ¨åŠ è½½ AI ç¥ç»ç½‘ç»œ...</div>
    <video class="input_video"></video>
    
    <div id="canvas-container"></div>

    <!-- HUD æ˜¾ç¤ºå±‚ -->
    <div id="gesture-hud">
        <h1 id="hud-result">--</h1>
        <p id="hud-desc">ç­‰å¾…æ‰‹åŠ¿</p>
    </div>

    <div id="ui-container">
        <div>æ”¯æŒæ‰‹åŠ¿ï¼šæ•°å­—0-5, OK, Rock</div>
    </div>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

// ================= é…ç½® =================
const CONFIG = {
    particleCount: 10000,
    color: new THREE.Color(0x00d2ff),
    activeGesture: 'NONE'
};

// DOM
const hudResult = document.getElementById('hud-result');
const hudDesc = document.getElementById('hud-desc');
const loading = document.getElementById('loading');

// Three.js å…¨å±€
let scene, camera, renderer, composer, particles;
let targetPositions = [];
let originalPositions = [];

// ================= 1. æ‰‹åŠ¿è¯†åˆ«é€»è¾‘ (æ ¸å¿ƒç®—æ³•) =================

function detectGesture(landmarks) {
    // å…³é”®ç‚¹ç´¢å¼•: 
    // æ‹‡æŒ‡: 4(Tip), 2(MCP) | é£ŸæŒ‡: 8(Tip), 6(PIP) | ä¸­æŒ‡: 12, 10 | æ— å: 16, 14 | å°æŒ‡: 20, 18
    
    const fingerTips = [8, 12, 16, 20];
    const fingerPips = [6, 10, 14, 18];
    
    // 1. åˆ¤æ–­æ‰‹æŒ‡æ˜¯å¦ä¼¸ç›´ (0: å¼¯æ›², 1: ä¼¸ç›´)
    let fingersUp = [0, 0, 0, 0, 0]; // æ‹‡æŒ‡, é£ŸæŒ‡, ä¸­æŒ‡, æ— å, å°æŒ‡

    // æ‹‡æŒ‡é€»è¾‘ (æ¯”è¾ƒ Tip.x å’Œ IP.xï¼Œæ ¹æ®å·¦å³æ‰‹ä¼šæœ‰ä¸åŒï¼Œç®€åŒ–ä¸ºè·ç¦»åˆ¤æ–­)
    // å¦‚æœæ‹‡æŒ‡å°–(4) åˆ° å°æŒ‡æ ¹(17) çš„è·ç¦» > æ‹‡æŒ‡èŠ‚(3) åˆ° å°æŒ‡æ ¹(17) çš„è·ç¦»ï¼Œè§†ä¸ºå¼ å¼€
    const distThumbTip = getDist(landmarks[4], landmarks[17]);
    const distThumbIp = getDist(landmarks[3], landmarks[17]);
    if (distThumbTip > distThumbIp * 1.2) fingersUp[0] = 1;

    // å…¶ä»–å››æŒ‡é€»è¾‘ (æ¯”è¾ƒ Y åæ ‡ï¼ŒYè¶Šå°è¶Šé ä¸Š)
    for (let i = 0; i < 4; i++) {
        if (landmarks[fingerTips[i]].y < landmarks[fingerPips[i]].y) {
            fingersUp[i+1] = 1;
        }
    }

    const count = fingersUp.reduce((a, b) => a + b, 0);

    // 2. ç‰¹æ®Šæ‰‹åŠ¿åˆ¤æ–­
    
    // ğŸŸ¢ åˆ¤æ–­ OK æ‰‹åŠ¿ (æ‹‡æŒ‡å°–å’Œé£ŸæŒ‡å°–è·ç¦»å¾ˆè¿‘ï¼Œä¸”å…¶ä»–ä¸‰æŒ‡ä¼¸ç›´)
    const distThumbIndex = getDist(landmarks[4], landmarks[8]);
    if (distThumbIndex < 0.05 && fingersUp[2] && fingersUp[3] && fingersUp[4]) {
        return { text: "OK", desc: "ç¡®è®¤/è¿è¡Œ", color: "#00ff00", type: "OK" };
    }

    // ğŸŸ¢ åˆ¤æ–­ Rock/Spider-man (é£ŸæŒ‡+å°æŒ‡+æ‹‡æŒ‡ä¼¸ç›´ï¼Œä¸­æŒ‡æ— åæŒ‡å¼¯æ›²)
    if (fingersUp[1] && fingersUp[4] && !fingersUp[2] && !fingersUp[3]) {
        return { text: "ğŸ¤˜", desc: "ROCK ON", color: "#ff0055", type: "ROCK" };
    }

    // ğŸŸ¢ åˆ¤æ–­ Victory/å‰ªåˆ€æ‰‹ (é£ŸæŒ‡+ä¸­æŒ‡)
    if (count === 2 && fingersUp[1] && fingersUp[2]) {
        return { text: "2", desc: "VICTORY", color: "#ffff00", type: "NUMBER" };
    }
    
    // ğŸŸ¢ åˆ¤æ–­ æ•°å­— 6 (æ‹‡æŒ‡+å°æŒ‡) - ä¸­å¼æ•°å­—
    if (count === 2 && fingersUp[0] && fingersUp[4]) {
        return { text: "6", desc: "CALL ME", color: "#ffaa00", type: "NUMBER" };
    }

    // ğŸŸ¢ æ™®é€šæ•°å­—
    if (count === 0) return { text: "0", desc: "FIST / æ‹³å¤´", color: "#555555", type: "NUMBER" };
    if (count === 1) return { text: "1", desc: "ONE", color: "#00d2ff", type: "NUMBER" };
    if (count === 3) return { text: "3", desc: "THREE", color: "#00d2ff", type: "NUMBER" };
    if (count === 4) return { text: "4", desc: "FOUR", color: "#00d2ff", type: "NUMBER" };
    if (count === 5) return { text: "5", desc: "PALM / åœæ­¢", color: "#ffffff", type: "NUMBER" };

    return { text: "--", desc: "...", color: "#444", type: "NONE" };
}

// è®¡ç®—ä¸¤ç‚¹æ¬§å‡ é‡Œå¾—è·ç¦»
function getDist(p1, p2) {
    return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
}

// ================= 2. MediaPipe åˆå§‹åŒ– =================

function initAI() {
    const video = document.getElementsByClassName('input_video')[0];
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    
    hands.setOptions({
        maxNumHands: 1, // å•æ‰‹æ¨¡å¼æ›´ç²¾å‡†
        modelComplexity: 1,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.5
    });

    hands.onResults(onResults);

    const cameraUtils = new Camera(video, {
        onFrame: async () => { await hands.send({image: video}); },
        width: 640, height: 480
    });
    
    cameraUtils.start().then(() => {
        loading.style.display = 'none';
    });
}

function onResults(results) {
    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        
        // è·å–è¯†åˆ«ç»“æœ
        const result = detectGesture(landmarks);
        
        // æ›´æ–° UI
        if (CONFIG.activeGesture !== result.text) {
            CONFIG.activeGesture = result.text;
            hudResult.innerText = result.text;
            hudResult.style.textShadow = `0 0 30px ${result.color}, 0 0 80px ${result.color}`;
            hudResult.style.color = result.color;
            hudDesc.innerText = result.desc;
            
            // è§¦å‘ç²’å­ç‰¹æ•ˆå˜åŒ–
            triggerParticleEffect(result.type, result.text);
        }
    }
}

// ================= 3. Three.js 3D ç²’å­ç³»ç»Ÿ =================

function initThree() {
    const container = document.getElementById('canvas-container');
    scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.02);
    
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 40;

    renderer = new THREE.WebGLRenderer({alpha:true, antialias:false});
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    // Bloom
    const renderScene = new RenderPass(scene, camera);
    const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
    bloomPass.strength = 2.0; bloomPass.radius = 0.5; bloomPass.threshold = 0;
    
    composer = new EffectComposer(renderer);
    composer.addPass(renderScene);
    composer.addPass(bloomPass);

    // Particles
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(CONFIG.particleCount * 3);
    for(let i=0; i<CONFIG.particleCount*3; i++) positions[i] = (Math.random()-0.5)*50;
    
    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    originalPositions = positions.slice(); // å¤‡ä»½
    targetPositions = positions.slice();   // ç›®æ ‡

    const material = new THREE.PointsMaterial({
        color: CONFIG.color,
        size: 0.5,
        blending: THREE.AdditiveBlending,
        transparent: true,
        opacity: 0.8
    });

    particles = new THREE.Points(geometry, material);
    scene.add(particles);

    animate();
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        composer.setSize(window.innerWidth, window.innerHeight);
    });
}

// æ ¹æ®æ‰‹åŠ¿æ”¹å˜ç²’å­å½¢æ€
function triggerParticleEffect(type, val) {
    const count = CONFIG.particleCount;
    const pos = new Float32Array(count * 3);

    for(let i=0; i<count; i++) {
        const u = Math.random(); const v = Math.random();
        let x, y, z;

        if (val === '0') { // æ‹³å¤´ï¼šèšé›†æˆçƒ
            const r = 8 * Math.cbrt(Math.random());
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2*Math.random()-1);
            x = r * Math.sin(phi) * Math.cos(theta);
            y = r * Math.sin(phi) * Math.sin(theta);
            z = r * Math.cos(phi);
            particles.material.color.setHex(0x555555);
        }
        else if (val === '5') { // æ‰‹æŒï¼šç‚¸å¼€/å¤§èŒƒå›´æ•£å¸ƒ
            x = (Math.random()-0.5) * 80;
            y = (Math.random()-0.5) * 80;
            z = (Math.random()-0.5) * 50;
            particles.material.color.setHex(0xffffff);
        }
        else if (type === 'OK') { // åœ†ç¯
            const r = 15;
            const t = u * Math.PI * 2;
            x = (r + (Math.random()-0.5)*2) * Math.cos(t);
            y = (r + (Math.random()-0.5)*2) * Math.sin(t);
            z = (Math.random()-0.5) * 5;
            particles.material.color.setHex(0x00ff00);
        }
        else if (val === '1') { // ç«–çº¿
            x = (Math.random()-0.5) * 4;
            y = (Math.random()-0.5) * 30;
            z = (Math.random()-0.5) * 4;
            particles.material.color.setHex(0x00d2ff);
        }
        else if (type === 'ROCK') { // æ··ä¹±/èƒ½é‡
             const r = 20 * u;
             const t = v * Math.PI * 2 * 5;
             x = r * Math.cos(t);
             y = r * Math.sin(t); // èºæ—‹
             z = (Math.random()-0.5) * 20;
             particles.material.color.setHex(0xff0055);
        }
        else { // é»˜è®¤ï¼šç«‹æ–¹ä½“
             const s = 20;
             x = (Math.random()-0.5)*s; y=(Math.random()-0.5)*s; z=(Math.random()-0.5)*s;
             particles.material.color.set(CONFIG.color);
        }

        targetPositions[i*3] = x;
        targetPositions[i*3+1] = y;
        targetPositions[i*3+2] = z;
    }
}

function animate() {
    requestAnimationFrame(animate);
    
    const positions = particles.geometry.attributes.position.array;
    
    // ç²’å­é£å‘ç›®æ ‡ä½ç½® (Lerp)
    for(let i=0; i<CONFIG.particleCount*3; i++) {
        positions[i] += (targetPositions[i] - positions[i]) * 0.05;
    }
    
    particles.geometry.attributes.position.needsUpdate = true;
    particles.rotation.y += 0.002;
    
    composer.render();
}

// å¯åŠ¨
initThree();
initAI();

</script>
</body>
</html>